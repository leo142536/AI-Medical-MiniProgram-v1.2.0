<!--pages/record/record.wxml-->
<view class="record-container">
  <!-- æœç´¢æ  -->
  <view class="search-bar">
    <view class="search-input-wrapper">
      <input 
        class="search-input"
        placeholder="æœç´¢ç—…å†è®°å½•..."
        value="{{searchKeyword}}"
        bindinput="onSearchInput"
      />
      <view class="search-actions">
        <text class="clear-btn" wx:if="{{searchKeyword}}" bindtap="onClearSearch">Ã—</text>
        <text class="filter-btn" bindtap="onShowFilter">ğŸ”</text>
      </view>
    </view>
  </view>

  <!-- æ ‡ç­¾é¡µ -->
  <view class="tabs-container">
    <view class="tabs">
      <view 
        class="tab {{activeTab === 0 ? 'active' : ''}}"
        data-index="0"
        bindtap="onTabChange"
      >
        <text>å…¨éƒ¨</text>
      </view>
      <view 
        class="tab {{activeTab === 1 ? 'active' : ''}}"
        data-index="1"
        bindtap="onTabChange"
      >
        <text>æœ€è¿‘</text>
      </view>
      <view 
        class="tab {{activeTab === 2 ? 'active' : ''}}"
        data-index="2"
        bindtap="onTabChange"
      >
        <text>é‡è¦</text>
      </view>
    </view>
  </view>

  <!-- ç—…å†åˆ—è¡¨ -->
  <scroll-view 
    class="record-list"
    scroll-y
    enable-flex
    refresher-enabled
    refresher-triggered="{{loading && page === 0}}"
    bindrefresherrefresh="refreshData"
    bindscrolltolower="loadMoreRecords"
  >
    <!-- åŠ è½½ä¸­çŠ¶æ€ -->
    <view class="loading-container" wx:if="{{loading && filteredRecords.length === 0}}">
      <loading-indicator type="skeleton" size="large" text="æ­£åœ¨åŠ è½½ç—…å†è®°å½•..." />
    </view>

    <!-- ç©ºçŠ¶æ€ -->
    <view class="empty-container" wx:elif="{{!loading && filteredRecords.length === 0}}">
      <view class="empty-icon">ğŸ“‹</view>
      <text class="empty-title">æš‚æ— ç—…å†è®°å½•</text>
      <text class="empty-desc">ç‚¹å‡»å³ä¸‹è§’æŒ‰é’®æ·»åŠ ç¬¬ä¸€æ¡ç—…å†</text>
      <button class="empty-action-btn" bindtap="onAddRecord">ç«‹å³æ·»åŠ </button>
    </view>

    <!-- ç—…å†å¡ç‰‡åˆ—è¡¨ -->
    <view class="modern-cards-container" wx:else>
      <modern-card 
        wx:for="{{filteredRecords}}" 
        wx:key="_id"
        title="{{item.title}}"
        subtitle="{{item.date}} {{item.time}}"
        description="ğŸ¥ {{item.hospital}}"
        image="{{item.images && item.images[0]}}"
        type="content"
        size="large"
        shadow="medium"
        hover-class="card-hover"
        bind:tap="onViewRecord"
        data-id="{{item._id}}"
      >
        <!-- ç´§æ€¥æ ‡è®° -->
        <view slot="badge" wx:if="{{item.urgent}}" class="urgent-badge">
          ç´§æ€¥
        </view>

        <!-- å¡ç‰‡å†…å®¹ -->
        <view slot="content" class="record-card-content">
          <!-- è¯Šæ–­ä¿¡æ¯ -->
          <view class="diagnosis-info" wx:if="{{item.diagnosis}}">
            <text class="diagnosis-label">è¯Šæ–­ï¼š</text>
            <text class="diagnosis-text">{{item.diagnosis}}</text>
          </view>

          <!-- ç—‡çŠ¶ä¿¡æ¯ -->
          <view class="symptoms-info" wx:if="{{item.symptoms}}">
            <text class="symptoms-label">ç—‡çŠ¶ï¼š</text>
            <text class="symptoms-text">{{item.symptoms}}</text>
          </view>

          <!-- æ²»ç–—ä¿¡æ¯ -->
          <view class="treatment-info" wx:if="{{item.treatment}}">
            <text class="treatment-label">æ²»ç–—ï¼š</text>
            <text class="treatment-text">{{item.treatment}}</text>
          </view>

          <!-- æˆå‘˜å’Œè´¹ç”¨ä¿¡æ¯ -->
          <view class="meta-info">
            <view class="member-info">
              <text class="member-icon">ğŸ‘¤</text>
              <text class="member-name">{{item.member}}</text>
            </view>
            <view class="cost-info" wx:if="{{item.cost}}">
              <text class="cost-icon">ğŸ’°</text>
              <text class="cost-amount">Â¥{{item.cost}}</text>
            </view>
            <view class="image-info" wx:if="{{item.images && item.images.length > 0}}">
              <text class="image-icon">ğŸ“·</text>
              <text class="image-count">{{item.images.length}}å¼ </text>
            </view>
          </view>
        </view>

        <!-- å¡ç‰‡åº•éƒ¨æ“ä½œ -->
        <view slot="footer" class="record-card-footer">
          <button 
            class="modern-btn secondary-btn"
            catchtap="onEditRecord"
            data-id="{{item._id}}"
          >
            ç¼–è¾‘
          </button>
          <button 
            class="modern-btn primary-btn"
            catchtap="onShareRecord"
            data-id="{{item._id}}"
          >
            åˆ†äº«
          </button>
          <view class="more-actions" catchtap="onMoreActions" data-id="{{item._id}}">
            <text class="more-icon">â‹¯</text>
          </view>
        </view>
      </modern-card>
    </view>

    <!-- åŠ è½½æ›´å¤š -->
    <view class="load-more" wx:if="{{hasMore && filteredRecords.length > 0}}">
      <loading-indicator 
        wx:if="{{loading}}" 
        type="dots" 
        size="small" 
        text="æ­£åœ¨åŠ è½½æ›´å¤š..." 
      />
      <text wx:else class="load-more-text">ä¸Šæ‹‰åŠ è½½æ›´å¤š</text>
    </view>

    <!-- æ²¡æœ‰æ›´å¤š -->
    <view class="no-more" wx:if="{{!hasMore && filteredRecords.length > 0}}">
      <text>å·²æ˜¾ç¤ºå…¨éƒ¨è®°å½•</text>
    </view>
  </scroll-view>

  <!-- æ·»åŠ æŒ‰é’® -->
  <view class="add-button" bindtap="onAddRecord">
    <text class="add-icon">+</text>
  </view>

  <!-- ç­›é€‰å¼¹çª— -->
  <view class="filter-modal" wx:if="{{showFilterModal}}">
    <view class="modal-mask" bindtap="onCloseFilter"></view>
    <view class="modal-content">
      <view class="modal-header">
        <text class="modal-title">ç­›é€‰æ¡ä»¶</text>
        <text class="modal-close" bindtap="onCloseFilter">Ã—</text>
      </view>
      
      <view class="filter-content">
        <!-- æ—¥æœŸèŒƒå›´ -->
        <view class="filter-item">
          <text class="filter-label">å¼€å§‹æ—¥æœŸ</text>
          <picker
            mode="date"
            value="{{filterOptions.startDate}}"
            data-field="startDate"
            bindchange="onFilterChange"
          >
            <view class="picker-input">
              <text class="{{!filterOptions.startDate ? 'placeholder' : ''}}">
                {{filterOptions.startDate || 'è¯·é€‰æ‹©å¼€å§‹æ—¥æœŸ'}}
              </text>
            </view>
          </picker>
        </view>

        <view class="filter-item">
          <text class="filter-label">ç»“æŸæ—¥æœŸ</text>
          <picker
            mode="date"
            value="{{filterOptions.endDate}}"
            data-field="endDate"
            bindchange="onFilterChange"
          >
            <view class="picker-input">
              <text class="{{!filterOptions.endDate ? 'placeholder' : ''}}">
                {{filterOptions.endDate || 'è¯·é€‰æ‹©ç»“æŸæ—¥æœŸ'}}
              </text>
            </view>
          </picker>
        </view>

        <!-- å®¶åº­æˆå‘˜ -->
        <view class="filter-item">
          <text class="filter-label">å®¶åº­æˆå‘˜</text>
          <picker
            range="{{familyMembers}}"
            range-key="name"
            value="{{filterOptions.memberIndex}}"
            data-field="member"
            bindchange="onFilterChange"
          >
            <view class="picker-input">
              <text class="{{!filterOptions.member ? 'placeholder' : ''}}">
                {{filterOptions.member || 'å…¨éƒ¨æˆå‘˜'}}
              </text>
            </view>
          </picker>
        </view>
      </view>

      <view class="modal-actions">
        <button class="reset-btn" bindtap="onResetFilter">é‡ç½®</button>
        <button class="apply-btn" bindtap="onApplyFilter">åº”ç”¨</button>
      </view>
    </view>
  </view>
</view> 