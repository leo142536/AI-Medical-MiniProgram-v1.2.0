<!--pages/record/record.wxml-->
<view class="record-container">
  <!-- æœç´¢æ  -->
  <view class="search-bar">
    <view class="search-input-wrapper">
      <input 
        class="search-input"
        placeholder="æœç´¢ç—…å†è®°å½•..."
        value="{{searchKeyword}}"
        bindinput="onSearchInput"
      />
      <view class="search-actions">
        <text class="clear-btn" wx:if="{{searchKeyword}}" bindtap="onClearSearch">Ã—</text>
        <text class="filter-btn" bindtap="onShowFilter">ğŸ”</text>
      </view>
    </view>
  </view>

  <!-- æ ‡ç­¾é¡µ -->
  <view class="tabs-container">
    <view class="tabs">
      <view 
        class="tab {{activeTab === 0 ? 'active' : ''}}"
        data-index="0"
        bindtap="onTabChange"
      >
        <text>å…¨éƒ¨</text>
      </view>
      <view 
        class="tab {{activeTab === 1 ? 'active' : ''}}"
        data-index="1"
        bindtap="onTabChange"
      >
        <text>æœ€è¿‘</text>
      </view>
      <view 
        class="tab {{activeTab === 2 ? 'active' : ''}}"
        data-index="2"
        bindtap="onTabChange"
      >
        <text>é‡è¦</text>
      </view>
    </view>
  </view>

  <!-- ç—…å†åˆ—è¡¨ -->
  <scroll-view 
    class="record-list"
    scroll-y
    enable-flex
    refresher-enabled
    refresher-triggered="{{loading && page === 0}}"
    bindrefresherrefresh="refreshData"
    bindscrolltolower="loadMoreRecords"
  >
    <!-- åŠ è½½ä¸­çŠ¶æ€ -->
    <view class="loading-container" wx:if="{{loading && filteredRecords.length === 0}}">
      <view class="loading-spinner"></view>
      <text class="loading-text">åŠ è½½ä¸­...</text>
    </view>

    <!-- ç©ºçŠ¶æ€ -->
    <view class="empty-container" wx:elif="{{!loading && filteredRecords.length === 0}}">
      <view class="empty-icon">ğŸ“‹</view>
      <text class="empty-title">æš‚æ— ç—…å†è®°å½•</text>
      <text class="empty-desc">ç‚¹å‡»å³ä¸‹è§’æŒ‰é’®æ·»åŠ ç¬¬ä¸€æ¡ç—…å†</text>
      <button class="empty-action-btn" bindtap="onAddRecord">ç«‹å³æ·»åŠ </button>
    </view>

    <!-- ç—…å†å¡ç‰‡åˆ—è¡¨ -->
    <view class="record-card-list" wx:else>
      <view 
        wx:for="{{filteredRecords}}" 
        wx:key="_id"
        class="record-card"
        data-id="{{item._id}}"
        bindtap="onViewRecord"
      >
        <!-- å¡ç‰‡å¤´éƒ¨ -->
        <view class="card-header">
          <view class="header-left">
            <text class="record-title">{{item.title}}</text>
            <view class="record-meta">
              <text class="record-date">{{item.date}} {{item.time}}</text>
              <text class="record-member">{{item.member}}</text>
            </view>
          </view>
          <view class="header-right">
            <text class="more-btn" catchtap="onMoreActions" data-id="{{item._id}}">â‹¯</text>
          </view>
        </view>

        <!-- åŒ»é™¢ä¿¡æ¯ -->
        <view class="hospital-info">
          <text class="hospital-name">ğŸ¥ {{item.hospital}}</text>
          <text class="diagnosis" wx:if="{{item.diagnosis}}">{{item.diagnosis}}</text>
        </view>

        <!-- ç—‡çŠ¶å’Œæ²»ç–— -->
        <view class="medical-info" wx:if="{{item.symptoms || item.treatment}}">
          <view class="symptoms" wx:if="{{item.symptoms}}">
            <text class="label">ç—‡çŠ¶ï¼š</text>
            <text class="content">{{item.symptoms}}</text>
          </view>
          <view class="treatment" wx:if="{{item.treatment}}">
            <text class="label">æ²»ç–—ï¼š</text>
            <text class="content">{{item.treatment}}</text>
          </view>
        </view>

        <!-- å¡ç‰‡åº•éƒ¨ -->
        <view class="card-footer">
          <view class="footer-left">
            <text class="cost" wx:if="{{item.cost}}">ğŸ’° Â¥{{item.cost}}</text>
            <text class="image-count" wx:if="{{item.images && item.images.length > 0}}">
              ğŸ“· {{item.images.length}}å¼ å›¾ç‰‡
            </text>
          </view>
          <view class="footer-right">
            <button 
              class="action-btn edit-btn"
              catchtap="onEditRecord"
              data-id="{{item._id}}"
            >ç¼–è¾‘</button>
            <button 
              class="action-btn share-btn"
              catchtap="onShareRecord"
              data-id="{{item._id}}"
            >åˆ†äº«</button>
          </view>
        </view>
      </view>
    </view>

    <!-- åŠ è½½æ›´å¤š -->
    <view class="load-more" wx:if="{{hasMore && filteredRecords.length > 0}}">
      <view class="load-more-spinner" wx:if="{{loading}}"></view>
      <text class="load-more-text">{{loading ? 'åŠ è½½ä¸­...' : 'ä¸Šæ‹‰åŠ è½½æ›´å¤š'}}</text>
    </view>

    <!-- æ²¡æœ‰æ›´å¤š -->
    <view class="no-more" wx:if="{{!hasMore && filteredRecords.length > 0}}">
      <text>å·²æ˜¾ç¤ºå…¨éƒ¨è®°å½•</text>
    </view>
  </scroll-view>

  <!-- æ·»åŠ æŒ‰é’® -->
  <view class="add-button" bindtap="onAddRecord">
    <text class="add-icon">+</text>
  </view>

  <!-- ç­›é€‰å¼¹çª— -->
  <view class="filter-modal" wx:if="{{showFilterModal}}">
    <view class="modal-mask" bindtap="onCloseFilter"></view>
    <view class="modal-content">
      <view class="modal-header">
        <text class="modal-title">ç­›é€‰æ¡ä»¶</text>
        <text class="modal-close" bindtap="onCloseFilter">Ã—</text>
      </view>
      
      <view class="filter-content">
        <!-- æ—¥æœŸèŒƒå›´ -->
        <view class="filter-item">
          <text class="filter-label">å¼€å§‹æ—¥æœŸ</text>
          <picker
            mode="date"
            value="{{filterOptions.startDate}}"
            data-field="startDate"
            bindchange="onFilterChange"
          >
            <view class="picker-input">
              <text class="{{!filterOptions.startDate ? 'placeholder' : ''}}">
                {{filterOptions.startDate || 'è¯·é€‰æ‹©å¼€å§‹æ—¥æœŸ'}}
              </text>
            </view>
          </picker>
        </view>

        <view class="filter-item">
          <text class="filter-label">ç»“æŸæ—¥æœŸ</text>
          <picker
            mode="date"
            value="{{filterOptions.endDate}}"
            data-field="endDate"
            bindchange="onFilterChange"
          >
            <view class="picker-input">
              <text class="{{!filterOptions.endDate ? 'placeholder' : ''}}">
                {{filterOptions.endDate || 'è¯·é€‰æ‹©ç»“æŸæ—¥æœŸ'}}
              </text>
            </view>
          </picker>
        </view>

        <!-- å®¶åº­æˆå‘˜ -->
        <view class="filter-item">
          <text class="filter-label">å®¶åº­æˆå‘˜</text>
          <picker
            range="{{familyMembers}}"
            range-key="name"
            value="{{filterOptions.memberIndex}}"
            data-field="member"
            bindchange="onFilterChange"
          >
            <view class="picker-input">
              <text class="{{!filterOptions.member ? 'placeholder' : ''}}">
                {{filterOptions.member || 'å…¨éƒ¨æˆå‘˜'}}
              </text>
            </view>
          </picker>
        </view>
      </view>

      <view class="modal-actions">
        <button class="reset-btn" bindtap="onResetFilter">é‡ç½®</button>
        <button class="apply-btn" bindtap="onApplyFilter">åº”ç”¨</button>
      </view>
    </view>
  </view>
</view> 