<!-- pages/family/family-optimized.wxml - å…¨é¢ä¼˜åŒ–çš„å®¶åº­æˆå‘˜ç®¡ç†é¡µé¢ -->
<view class="family-container-modern">
  <!-- é¡¶éƒ¨å¯¼èˆªåŒºåŸŸ -->
  <view class="top-header-modern">
    <view class="header-content">
      <view class="header-left">
        <text class="page-title-modern text-2xl">æˆ‘çš„å®¶åº­</text>
        <text class="page-subtitle text-sm" wx:if="{{familyInfo}}">{{familyInfo.name}}</text>
      </view>
      <view class="header-actions">
        <view class="action-btn-modern" bindtap="onFamilySettings">
          <text class="action-icon">âš™ï¸</text>
        </view>
        <view class="action-btn-modern" bindtap="onFamilyShare">
          <text class="action-icon">ğŸ“¤</text>
        </view>
        <view class="action-btn-modern" bindtap="onFamilyStats">
          <text class="action-icon">ğŸ“Š</text>
        </view>
      </view>
    </view>
  </view>

  <!-- æ™ºèƒ½å®¶åº­æ¦‚è§ˆå¡ç‰‡ -->
  <view class="family-overview-card" wx:if="{{familyInfo}}">
    <view class="overview-header">
      <view class="family-avatar-group">
        <view 
          class="family-member-avatar"
          wx:for="{{recentMembers}}"
          wx:key="id"
          style="z-index: {{recentMembers.length - index}}"
        >
          <image class="avatar-image" src="{{item.avatar}}" mode="aspectFill" />
          <view class="online-indicator" wx:if="{{item.isOnline}}"></view>
        </view>
        <view class="more-members" wx:if="{{members.length > 4}}">
          <text class="more-count">+{{members.length - 4}}</text>
        </view>
      </view>
      
      <view class="family-main-info">
        <text class="family-name-modern">{{familyInfo.name}}</text>
        <text class="family-description">{{familyInfo.description || 'æ¸©é¦¨çš„å®¶åº­'}}</text>
        <view class="family-tags">
          <text class="family-tag">{{members.length}}ä½æˆå‘˜</text>
          <text class="family-tag" wx:if="{{familyInfo.createdDays}}">åˆ›å»º{{familyInfo.createdDays}}å¤©</text>
        </view>
      </view>
    </view>

    <!-- å®¶åº­å¥åº·ä»ªè¡¨æ¿ -->
    <view class="health-dashboard">
      <view class="dashboard-header">
        <text class="dashboard-title">ğŸ¥ å®¶åº­å¥åº·æ¦‚è§ˆ</text>
        <text class="dashboard-period">æœ¬æœˆ</text>
      </view>
      
      <view class="health-stats-grid">
        <view class="health-stat-item">
          <view class="stat-icon-wrapper stat-medical">
            <text class="stat-icon">ğŸ“‹</text>
          </view>
          <view class="stat-content">
            <text class="stat-value">{{healthStats.totalRecords}}</text>
            <text class="stat-label">ç—…å†è®°å½•</text>
            <text class="stat-change positive" wx:if="{{healthStats.recordsChange > 0}}">
              +{{healthStats.recordsChange}}
            </text>
          </view>
        </view>
        
        <view class="health-stat-item">
          <view class="stat-icon-wrapper stat-reminder">
            <text class="stat-icon">â°</text>
          </view>
          <view class="stat-content">
            <text class="stat-value">{{healthStats.activeReminders}}</text>
            <text class="stat-label">æ´»è·ƒæé†’</text>
            <text class="stat-change" class="{{healthStats.remindersChange > 0 ? 'positive' : 'negative'}}">
              {{healthStats.remindersChange > 0 ? '+' : ''}}{{healthStats.remindersChange}}
            </text>
          </view>
        </view>
        
        <view class="health-stat-item">
          <view class="stat-icon-wrapper stat-checkup">
            <text class="stat-icon">ğŸ”</text>
          </view>
          <view class="stat-content">
            <text class="stat-value">{{healthStats.checkups}}</text>
            <text class="stat-label">ä½“æ£€æ¬¡æ•°</text>
            <text class="stat-note">è·ä¸‹æ¬¡{{healthStats.nextCheckup}}å¤©</text>
          </view>
        </view>
        
        <view class="health-stat-item">
          <view class="stat-icon-wrapper stat-medicine">
            <text class="stat-icon">ğŸ’Š</text>
          </view>
          <view class="stat-content">
            <text class="stat-value">{{healthStats.medicationCompliance}}%</text>
            <text class="stat-label">ç”¨è¯ä¾ä»</text>
            <text class="stat-note">{{healthStats.medicationStatus}}</text>
          </view>
        </view>
      </view>

      <!-- AIå¥åº·è¯„åˆ† -->
      <view class="ai-health-score" wx:if="{{aiHealthScore}}">
        <view class="score-header">
          <text class="score-title">ğŸ¤– AIå®¶åº­å¥åº·è¯„åˆ†</text>
          <text class="score-period">åŸºäºè¿‘30å¤©æ•°æ®åˆ†æ</text>
        </view>
        <view class="score-content">
          <view class="score-circle">
            <view class="score-progress" style="--progress: {{aiHealthScore.percentage}}%">
              <text class="score-number">{{aiHealthScore.score}}</text>
              <text class="score-total">/100</text>
            </view>
          </view>
          <view class="score-details">
            <text class="score-level score-{{aiHealthScore.level}}">{{aiHealthScore.levelText}}</text>
            <text class="score-description">{{aiHealthScore.description}}</text>
            <view class="score-suggestions">
              <text 
                class="suggestion-item"
                wx:for="{{aiHealthScore.suggestions}}"
                wx:key="*this"
              >â€¢ {{item}}</text>
            </view>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- æ™ºèƒ½æˆå‘˜ç®¡ç†åŒºåŸŸ -->
  <view class="members-management-section">
    <view class="section-header-modern">
      <view class="header-left">
        <text class="section-title-modern">ğŸ‘¥ å®¶åº­æˆå‘˜</text>
        <text class="section-subtitle">{{members.length}}ä½æˆå‘˜</text>
      </view>
      <view class="header-actions">
        <view class="quick-action-btn" bindtap="onBulkManage">
          <text class="action-icon">ğŸ“</text>
          <text class="action-text">æ‰¹é‡ç®¡ç†</text>
        </view>
        <view class="add-member-btn btn-modern btn-modern-primary" bindtap="onAddMember">
          <text class="btn-icon">+</text>
          <text class="btn-text">æ·»åŠ æˆå‘˜</text>
        </view>
      </view>
    </view>

    <!-- æˆå‘˜æœç´¢å’Œç­›é€‰ -->
    <view class="members-filter-bar">
      <view class="search-input-container">
        <view class="search-icon">ğŸ”</view>
        <input 
          class="search-input-modern"
          placeholder="æœç´¢å®¶åº­æˆå‘˜..."
          value="{{searchKeyword}}"
          bindinput="onSearchMembers"
        />
        <view class="search-actions" wx:if="{{searchKeyword}}">
          <text class="clear-search-btn" bindtap="onClearSearch">Ã—</text>
        </view>
      </view>
      
      <view class="filter-options">
        <view 
          class="filter-chip {{activeFilter === 'all' ? 'active' : ''}}"
          data-filter="all"
          bindtap="onFilterMembers"
        >
          <text class="chip-text">å…¨éƒ¨</text>
        </view>
        <view 
          class="filter-chip {{activeFilter === 'adults' ? 'active' : ''}}"
          data-filter="adults"
          bindtap="onFilterMembers"
        >
          <text class="chip-text">æˆäºº</text>
        </view>
        <view 
          class="filter-chip {{activeFilter === 'children' ? 'active' : ''}}"
          data-filter="children"
          bindtap="onFilterMembers"
        >
          <text class="chip-text">å„¿ç«¥</text>
        </view>
        <view 
          class="filter-chip {{activeFilter === 'elderly' ? 'active' : ''}}"
          data-filter="elderly"
          bindtap="onFilterMembers"
        >
          <text class="chip-text">è€äºº</text>
        </view>
      </view>
    </view>

    <!-- ç°ä»£åŒ–æˆå‘˜å¡ç‰‡åˆ—è¡¨ -->
    <view class="members-grid-modern">
      <view 
        class="member-card-modern card-modern touchable-card"
        wx:for="{{filteredMembers}}"
        wx:key="id"
        data-id="{{item.id}}"
        bindtap="onMemberDetail"
        bindlongpress="onMemberLongPress"
      >
        <!-- æˆå‘˜çŠ¶æ€æŒ‡ç¤ºå™¨ -->
        <view class="member-status-indicator status-{{item.healthStatus || 'normal'}}"></view>
        
        <!-- æˆå‘˜å¤´åƒåŒºåŸŸ -->
        <view class="member-avatar-section">
          <view class="avatar-container">
            <image 
              class="member-avatar-image" 
              src="{{item.avatar || '/images/default-avatar.png'}}" 
              mode="aspectFill"
              lazy-load
            />
            <view class="avatar-overlay">
              <text class="quick-action-icon">ğŸ“‹</text>
            </view>
            
            <!-- è§’è‰²å¾½ç«  -->
            <view class="role-badge role-{{item.role || 'member'}}" wx:if="{{item.role}}">
              <text class="role-text">{{getRoleText(item.role)}}</text>
            </view>
            
            <!-- åœ¨çº¿çŠ¶æ€ -->
            <view class="online-status" wx:if="{{item.isOnline}}">
              <view class="online-dot"></view>
            </view>
          </view>
        </view>

        <!-- æˆå‘˜åŸºæœ¬ä¿¡æ¯ -->
        <view class="member-info-section">
          <view class="member-main-info">
            <text class="member-name-modern">{{item.name}}</text>
            <text class="member-relation-modern">{{item.relation}}</text>
          </view>
          
          <view class="member-details">
            <view class="detail-item">
              <text class="detail-icon">{{item.gender === 'male' ? 'ğŸ‘¨' : 'ğŸ‘©'}}</text>
              <text class="detail-text">{{getAge(item.birthday)}}å²</text>
            </view>
            <view class="detail-item" wx:if="{{item.bloodType}}">
              <text class="detail-icon">ğŸ©¸</text>
              <text class="detail-text">{{item.bloodType}}å‹</text>
            </view>
            <view class="detail-item" wx:if="{{item.phone}}">
              <text class="detail-icon">ğŸ“±</text>
              <text class="detail-text">{{item.phone.slice(-4)}}</text>
            </view>
          </view>
        </view>

        <!-- å¥åº·çŠ¶æ€ä¿¡æ¯ -->
        <view class="member-health-section" wx:if="{{item.healthSummary}}">
          <view class="health-header">
            <text class="health-title">å¥åº·çŠ¶æ€</text>
            <view class="health-score-mini">
              <text class="score-value-mini">{{item.healthSummary.score}}</text>
            </view>
          </view>
          
          <view class="health-indicators">
            <view class="health-indicator" wx:if="{{item.healthSummary.lastCheckup}}">
              <text class="indicator-icon">ğŸ¥</text>
              <text class="indicator-text">ä¸Šæ¬¡ä½“æ£€{{item.healthSummary.lastCheckup}}</text>
            </view>
            <view class="health-indicator" wx:if="{{item.healthSummary.medications}}">
              <text class="indicator-icon">ğŸ’Š</text>
              <text class="indicator-text">{{item.healthSummary.medications}}ç§å¸¸ç”¨è¯</text>
            </view>
            <view class="health-indicator" wx:if="{{item.healthSummary.conditions}}">
              <text class="indicator-icon">âš ï¸</text>
              <text class="indicator-text">{{item.healthSummary.conditions}}ä¸ªå…³æ³¨é¡¹</text>
            </view>
          </view>

          <!-- AIå¥åº·æé†’ -->
          <view class="ai-health-alerts" wx:if="{{item.aiAlerts && item.aiAlerts.length > 0}}">
            <view 
              class="ai-alert-item alert-{{alert.level}}"
              wx:for="{{item.aiAlerts}}"
              wx:for-item="alert"
              wx:key="id"
            >
              <text class="alert-icon">{{alert.icon}}</text>
              <text class="alert-text">{{alert.message}}</text>
            </view>
          </view>
        </view>

        <!-- å¿«é€Ÿæ“ä½œåŒºåŸŸ -->
        <view class="member-actions-section">
          <view class="quick-actions">
            <view class="quick-action-item" catchtap="onQuickAddRecord" data-member="{{item}}">
              <text class="quick-action-icon">ğŸ“</text>
              <text class="quick-action-text">è®°å½•</text>
            </view>
            <view class="quick-action-item" catchtap="onQuickReminder" data-member="{{item}}">
              <text class="quick-action-icon">â°</text>
              <text class="quick-action-text">æé†’</text>
            </view>
            <view class="quick-action-item" catchtap="onMemberCall" data-member="{{item}}" wx:if="{{item.phone}}">
              <text class="quick-action-icon">ğŸ“</text>
              <text class="quick-action-text">å‘¼å«</text>
            </view>
            <view class="quick-action-item more-actions" catchtap="onMoreMemberActions" data-member="{{item}}">
              <text class="quick-action-icon">â‹¯</text>
            </view>
          </view>
        </view>

        <!-- æœ€è¿‘æ´»åŠ¨æ—¶é—´çº¿ -->
        <view class="member-activity-timeline" wx:if="{{item.recentActivities && item.recentActivities.length > 0}}">
          <view class="timeline-header">
            <text class="timeline-title">æœ€è¿‘æ´»åŠ¨</text>
            <text class="timeline-more" catchtap="onViewMemberHistory" data-id="{{item.id}}">æŸ¥çœ‹æ›´å¤š</text>
          </view>
          <view class="timeline-items">
            <view 
              class="timeline-item-mini"
              wx:for="{{item.recentActivities}}"
              wx:for-item="activity"
              wx:key="id"
            >
              <view class="timeline-dot timeline-{{activity.type}}"></view>
              <view class="timeline-content-mini">
                <text class="timeline-text">{{activity.description}}</text>
                <text class="timeline-time">{{activity.timeAgo}}</text>
              </view>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- åŠ è½½æ›´å¤š -->
    <view class="load-more-members" wx:if="{{hasMoreMembers}}">
      <view class="load-more-content">
        <view class="loading-spinner" wx:if="{{loadingMembers}}"></view>
        <text class="load-more-text">{{loadingMembers ? 'åŠ è½½ä¸­...' : 'åŠ è½½æ›´å¤šæˆå‘˜'}}</text>
      </view>
    </view>
  </view>

  <!-- æ™ºèƒ½å®¶åº­å»ºè®® -->
  <view class="family-suggestions-section" wx:if="{{familySuggestions && familySuggestions.length > 0}}">
    <view class="suggestions-header">
      <text class="suggestions-title">ğŸ¤– AIæ™ºèƒ½å»ºè®®</text>
      <text class="suggestions-subtitle">åŸºäºå®¶åº­å¥åº·æ•°æ®åˆ†æ</text>
    </view>
    
    <scroll-view class="suggestions-scroll" scroll-x>
      <view class="suggestions-list">
        <view 
          class="suggestion-card"
          wx:for="{{familySuggestions}}"
          wx:key="id"
          data-suggestion="{{item}}"
          bindtap="onApplySuggestion"
        >
          <view class="suggestion-icon-wrapper">
            <text class="suggestion-icon">{{item.icon}}</text>
          </view>
          <view class="suggestion-content">
            <text class="suggestion-title">{{item.title}}</text>
            <text class="suggestion-description">{{item.description}}</text>
          </view>
          <view class="suggestion-action">
            <text class="action-text">{{item.actionText}}</text>
            <text class="action-arrow">â†’</text>
          </view>
        </view>
      </view>
    </scroll-view>
  </view>

  <!-- å®¶åº­æˆå°±å’Œé‡Œç¨‹ç¢‘ -->
  <view class="family-achievements-section" wx:if="{{familyAchievements && familyAchievements.length > 0}}">
    <view class="achievements-header">
      <text class="achievements-title">ğŸ† å®¶åº­æˆå°±</text>
      <text class="achievements-count">å·²è§£é” {{unlockedAchievements}}/{{totalAchievements}}</text>
    </view>
    
    <view class="achievements-grid">
      <view 
        class="achievement-item {{achievement.unlocked ? 'unlocked' : 'locked'}}"
        wx:for="{{familyAchievements}}"
        wx:for-item="achievement"
        wx:key="id"
        data-achievement="{{achievement}}"
        bindtap="onViewAchievement"
      >
        <view class="achievement-icon-wrapper">
          <text class="achievement-icon">{{achievement.icon}}</text>
          <view class="achievement-progress" wx:if="{{!achievement.unlocked}}">
            <text class="progress-text">{{achievement.progress}}/{{achievement.target}}</text>
          </view>
        </view>
        <view class="achievement-info">
          <text class="achievement-title">{{achievement.title}}</text>
          <text class="achievement-description">{{achievement.description}}</text>
        </view>
      </view>
    </view>
  </view>

  <!-- ç©ºçŠ¶æ€ -->
  <view class="empty-state-family" wx:if="{{!familyInfo}}">
    <view class="empty-animation-container">
      <text class="empty-icon-animated">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦</text>
      <view class="empty-particles">
        <view class="particle" wx:for="{{[1,2,3,4,5]}}" wx:key="*this"></view>
      </view>
    </view>
    <text class="empty-title-modern">æ¬¢è¿åˆ›å»ºæ‚¨çš„å®¶åº­</text>
    <text class="empty-description-modern">
      å¼€å§‹ç®¡ç†å®¶åº­æˆå‘˜çš„å¥åº·ä¿¡æ¯ï¼Œè®©AIä¸ºæ‚¨æä¾›æ™ºèƒ½åˆ†æå’Œå»ºè®®
    </text>
    
    <view class="empty-actions">
      <button class="create-family-btn btn-modern btn-modern-primary" bindtap="onCreateFamily">
        <text class="btn-icon">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦</text>
        <text class="btn-text">åˆ›å»ºå®¶åº­</text>
      </button>
      <button class="join-family-btn btn-modern btn-modern-outline" bindtap="onJoinFamily">
        <text class="btn-icon">ğŸ”—</text>
        <text class="btn-text">åŠ å…¥å®¶åº­</text>
      </button>
    </view>
    
    <view class="empty-features">
      <view class="feature-item">
        <text class="feature-icon">ğŸ¥</text>
        <text class="feature-text">å¥åº·è®°å½•ç®¡ç†</text>
      </view>
      <view class="feature-item">
        <text class="feature-icon">ğŸ¤–</text>
        <text class="feature-text">AIæ™ºèƒ½åˆ†æ</text>
      </view>
      <view class="feature-item">
        <text class="feature-icon">â°</text>
        <text class="feature-text">æ™ºèƒ½å¥åº·æé†’</text>
      </view>
    </view>
  </view>

  <!-- æµ®åŠ¨å¿«é€Ÿæ“ä½œèœå• -->
  <view class="floating-quick-menu" wx:if="{{showQuickMenu}}">
    <view class="quick-menu-overlay" bindtap="onCloseQuickMenu"></view>
    <view class="quick-menu-content">
      <view class="quick-menu-header">
        <text class="menu-title">å¿«é€Ÿæ“ä½œ</text>
        <text class="menu-close" bindtap="onCloseQuickMenu">Ã—</text>
      </view>
      
      <view class="quick-menu-items">
        <view class="quick-menu-item" bindtap="onQuickAddMember">
          <view class="menu-item-icon">ğŸ‘¤</view>
          <view class="menu-item-content">
            <text class="menu-item-title">æ·»åŠ æˆå‘˜</text>
            <text class="menu-item-desc">é‚€è¯·å®¶åº­æˆå‘˜åŠ å…¥</text>
          </view>
        </view>
        
        <view class="quick-menu-item" bindtap="onQuickFamilyRecord">
          <view class="menu-item-icon">ğŸ“‹</view>
          <view class="menu-item-content">
            <text class="menu-item-title">å®¶åº­è®°å½•</text>
            <text class="menu-item-desc">æŸ¥çœ‹å®¶åº­å¥åº·è®°å½•</text>
          </view>
        </view>
        
        <view class="quick-menu-item" bindtap="onQuickFamilyReport">
          <view class="menu-item-icon">ğŸ“Š</view>
          <view class="menu-item-content">
            <text class="menu-item-title">å¥åº·æŠ¥å‘Š</text>
            <text class="menu-item-desc">ç”Ÿæˆå®¶åº­å¥åº·æŠ¥å‘Š</text>
          </view>
        </view>
        
        <view class="quick-menu-item" bindtap="onQuickEmergencyContacts">
          <view class="menu-item-icon">ğŸš¨</view>
          <view class="menu-item-content">
            <text class="menu-item-title">ç´§æ€¥è”ç³»</text>
            <text class="menu-item-desc">è®¾ç½®ç´§æ€¥è”ç³»äºº</text>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- å…¨å±€åŠ è½½é®ç½© -->
  <view class="global-loading-overlay" wx:if="{{globalLoading}}">
    <view class="global-loading-content">
      <view class="loading-spinner-large"></view>
      <text class="global-loading-text">{{loadingText || 'å¤„ç†ä¸­...'}}</text>
    </view>
  </view>
</view> 