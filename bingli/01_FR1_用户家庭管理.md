# FR1 - 用户家庭管理功能需求

## 1. 功能概述

用户家庭管理模块是整个AI病例管理系统的基础模块，负责用户身份认证、家庭成员信息管理以及权限控制等核心功能。

## 2. 功能需求

### 2.1 用户注册与登录

#### 2.1.1 微信授权登录
- **功能描述**：用户通过微信授权快速登录系统
- **输入**：微信授权信息
- **输出**：用户登录状态、基本信息
- **业务规则**：
  - 首次登录自动创建用户账户
  - 获取用户微信昵称和头像
  - 生成唯一用户ID

#### 2.1.2 用户信息完善
- **功能描述**：用户补充个人基本信息
- **输入**：姓名、手机号、性别、生日等
- **输出**：完整的用户档案
- **业务规则**：
  - 手机号码格式验证
  - 必填信息检查
  - 信息修改记录

### 2.2 家庭成员管理

#### 2.2.1 添加家庭成员
- **功能描述**：用户可以添加家庭成员信息
- **输入**：成员姓名、关系、性别、生日、头像等
- **输出**：新增的家庭成员档案
- **业务规则**：
  - 支持的关系类型：本人、配偶、子女、父母、其他
  - 每个家庭最多支持10个成员
  - 成员信息必填项验证

#### 2.2.2 编辑家庭成员
- **功能描述**：修改已有家庭成员的信息
- **输入**：成员ID、修改的信息字段
- **输出**：更新后的成员信息
- **业务规则**：
  - 只有创建者可以编辑成员信息
  - 修改操作记录日志
  - 关键信息变更需要确认

#### 2.2.3 删除家庭成员
- **功能描述**：移除家庭成员
- **输入**：成员ID
- **输出**：删除确认结果
- **业务规则**：
  - 删除前需要用户确认
  - 删除成员时同时删除相关病历数据
  - 软删除机制，支持恢复

#### 2.2.4 成员信息查看
- **功能描述**：查看家庭成员详细信息
- **输入**：成员ID
- **输出**：成员详细档案
- **业务规则**：
  - 显示成员基本信息
  - 显示病历统计信息
  - 显示最近就医记录

### 2.3 权限管理

#### 2.3.1 角色定义
- **主管理员**：家庭创建者，拥有所有权限
- **管理员**：可以管理指定成员的病历
- **查看者**：只能查看指定成员的病历
- **自管理**：只能管理自己的病历

#### 2.3.2 权限分配
- **功能描述**：为家庭成员分配不同的管理权限
- **输入**：成员ID、权限级别、管理范围
- **输出**：权限设置结果
- **业务规则**：
  - 主管理员可以设置所有权限
  - 管理员可以设置查看者权限
  - 权限变更需要通知相关用户

#### 2.3.3 权限验证
- **功能描述**：在操作前验证用户权限
- **输入**：用户ID、操作类型、目标资源
- **输出**：权限验证结果
- **业务规则**：
  - 每次敏感操作都需要权限验证
  - 权限不足时给出明确提示
  - 记录权限验证日志

## 3. 界面设计要求

### 3.1 家庭成员列表页面
- 显示所有家庭成员卡片
- 支持添加新成员的悬浮按钮
- 成员卡片显示头像、姓名、关系、年龄
- 支持左滑删除操作

### 3.2 成员详情页面
- 显示成员完整信息
- 提供编辑按钮
- 显示病历统计信息
- 显示最近活动记录

### 3.3 添加/编辑成员页面
- 表单式布局
- 头像上传功能
- 关系选择器
- 日期选择器
- 表单验证提示

### 3.4 权限管理页面
- 成员权限列表
- 权限级别选择器
- 管理范围设置
- 权限说明文档

## 4. 数据模型

### 4.1 用户表 (users)
```javascript
{
  _id: ObjectId,
  openid: String,           // 微信openid
  unionid: String,          // 微信unionid
  nickName: String,         // 微信昵称
  avatarUrl: String,        // 微信头像
  realName: String,         // 真实姓名
  phone: String,            // 手机号
  gender: Number,           // 性别 0-未知 1-男 2-女
  birthday: Date,           // 生日
  createTime: Date,         // 创建时间
  updateTime: Date,         // 更新时间
  status: Number            // 状态 1-正常 0-禁用
}
```

### 4.2 家庭成员表 (family_members)
```javascript
{
  _id: ObjectId,
  userId: ObjectId,         // 所属用户ID
  name: String,             // 成员姓名
  relationship: String,     // 关系类型
  gender: Number,           // 性别
  birthday: Date,           // 生日
  avatar: String,           // 头像URL
  idCard: String,           // 身份证号(加密)
  phone: String,            // 联系电话
  emergencyContact: String, // 紧急联系人
  allergies: Array,         // 过敏史
  chronicDiseases: Array,   // 慢性病史
  createTime: Date,         // 创建时间
  updateTime: Date,         // 更新时间
  status: Number            // 状态 1-正常 0-删除
}
```

### 4.3 权限表 (permissions)
```javascript
{
  _id: ObjectId,
  userId: ObjectId,         // 用户ID
  targetUserId: ObjectId,   // 目标用户ID
  memberId: ObjectId,       // 成员ID
  role: String,             // 角色类型
  permissions: Array,       // 权限列表
  createTime: Date,         // 创建时间
  updateTime: Date,         // 更新时间
  status: Number            // 状态
}
```

## 5. API接口设计

### 5.1 用户相关接口
- `POST /api/user/login` - 用户登录
- `GET /api/user/profile` - 获取用户信息
- `PUT /api/user/profile` - 更新用户信息
- `POST /api/user/logout` - 用户登出

### 5.2 家庭成员相关接口
- `GET /api/family/members` - 获取家庭成员列表
- `POST /api/family/members` - 添加家庭成员
- `GET /api/family/members/:id` - 获取成员详情
- `PUT /api/family/members/:id` - 更新成员信息
- `DELETE /api/family/members/:id` - 删除成员

### 5.3 权限相关接口
- `GET /api/permissions` - 获取权限列表
- `POST /api/permissions` - 设置权限
- `PUT /api/permissions/:id` - 更新权限
- `DELETE /api/permissions/:id` - 删除权限

## 6. 异常处理

### 6.1 常见异常
- 网络连接异常
- 数据格式错误
- 权限不足
- 资源不存在
- 服务器内部错误

### 6.2 异常处理策略
- 友好的错误提示
- 自动重试机制
- 离线数据缓存
- 错误日志记录

## 7. 测试用例

### 7.1 功能测试
- 用户登录流程测试
- 成员添加/编辑/删除测试
- 权限设置和验证测试
- 数据同步测试

### 7.2 性能测试
- 大量成员数据加载测试
- 并发操作测试
- 内存使用测试

### 7.3 安全测试
- 权限绕过测试
- 数据泄露测试
- 输入验证测试
